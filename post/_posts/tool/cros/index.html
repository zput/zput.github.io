<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>大话跨域 - Zput's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="zput"><meta name=description content="跨域相关知识：what,why，how"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.101.0 with theme even"><link rel=canonical href=http://zput.github.io/post/_posts/tool/cros/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.fdb1035139209ff03fa34c28400ff54f04900828b7cafe0d2cfb1f48b70a2ffd.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="大话跨域"><meta property="og:description" content="跨域相关知识：what,why，how"><meta property="og:type" content="article"><meta property="og:url" content="http://zput.github.io/post/_posts/tool/cros/"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-05-24T12:33:00+00:00"><meta property="article:modified_time" content="2018-05-24T12:33:00+00:00"><meta itemprop=name content="大话跨域"><meta itemprop=description content="跨域相关知识：what,why，how"><meta itemprop=datePublished content="2018-05-24T12:33:00+00:00"><meta itemprop=dateModified content="2018-05-24T12:33:00+00:00"><meta itemprop=wordCount content="2251"><meta itemprop=keywords content="Http,"><meta name=twitter:card content="summary"><meta name=twitter:title content="大话跨域"><meta name=twitter:description content="跨域相关知识：what,why，how"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Zput</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/go-goroutine><li class=mobile-menu-item>go源码专栏</li></a><a href=/post/mrmk/><li class=mobile-menu-item>(数据库/消息/...)专栏</li></a><a href=/post/postgraduate/><li class=mobile-menu-item>考研专栏</li></a><a href=/categories/><li class=mobile-menu-item>技术类别</li></a><a href=/post/><li class=mobile-menu-item>时间线</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Zput</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/go-goroutine>go源码专栏</a></li><li class=menu-item><a class=menu-item-link href=/post/mrmk/>(数据库/消息/...)专栏</a></li><li class=menu-item><a class=menu-item-link href=/post/postgraduate/>考研专栏</a></li><li class=menu-item><a class=menu-item-link href=/categories/>技术类别</a></li><li class=menu-item><a class=menu-item-link href=/post/>时间线</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>大话跨域</h1><div class=post-meta><span class=post-time>2018-05-24</span><div class=post-category><a href=/categories/%E7%BD%91%E7%BB%9C/>网络</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#cros>cros</a><ul><li><a href=#what什么是跨域>what:什么是跨域？</a></li><li><a href=#why-为什么不让我跨域>why: 为什么不让我跨域？</a></li><li><a href=#how-解决跨域问题>how: 解决跨域问题:</a></li><li><a href=#点击劫持>点击劫持</a></li></ul></li><li><a href=#附录>附录</a></li></ul></li></ul></nav></div></div><div class=article-container><div class=post-content><h2 id=cros>cros</h2><h3 id=what什么是跨域>what:什么是跨域？</h3><ul><li>我有一个域名a.com和一个域名b.com</li><li>我在a.com上有一个接口a.com/api，会返回一些数据</li><li>我想在b.com域名下的一个页面上访问a.com/api得到数据</li><li>浏览器阻止了我</li></ul><h3 id=why-为什么不让我跨域>why: 为什么不让我跨域？</h3><ul><li><p>因为在web交互的环境中，只能保证请求发自某个用户的浏览器，却不能保证请求本身是用户自愿发出的。</p></li><li><p>跨站请求伪造（CSRF）</p><ul><li><ol><li>支付宝的转账操作是一个post请求，大概是https://alipay.com/api/withdraw/?to_user=XXX&amout=1000</li></ol></li><li><ol start=2><li>我写了一段ajax的post请求代码，请求连接是上面的url。</li></ol></li><li><ol start=3><li>然后我把这段代码嵌入我的网站a.com你不久前登陆过支付宝，</li></ol></li><li><ol start=4><li>浏览器里保存了alipay.com域名的cookie</li></ol></li><li><ol start=5><li>我让你访问a.com，打开页面，于是在你不知情的情况下发出了post请求，你的钱就被转到我的账号里了</li></ol></li></ul></li></ul><h3 id=how-解决跨域问题>how: 解决跨域问题:</h3><ul><li>发请求前设置一下document.domain的值.<ul><li>父子域名</li></ul></li><li>JSONP&mdash;json with padding.<ul><li>在非父子域关系的情况下，如developer.mozilla.org和production.mozilla.org（或者a.com和b.com），就是被浏览器当作两个不同的域名的，一般就会使用JSONP了.</li></ul></li><li>跨域资源共享（CORS）.<ul><li>简单请求&mdash;GET和POST。</li><li>预检请求&mdash;PUT和DELETE等，或者请求时添加了CORS安全的header之外的header（如自定义的）。</li><li>带cookie的请求&mdash;要求响应头里<code>Access-Control-Allow-Credentials</code>为true，且<code>Access-Control-Allow-Origin</code>不能是通配符，防止后端犯错。</li></ul></li></ul><h4 id=documentdomain>document.domain</h4><ul><li>如果是子域名下的页面想访问父域的api，如developer.mozilla.org想访问mozilla.org的api，那可以在发请求前设置一下document.domain的值为mozilla.org。毕竟是子域，浏览器几乎没有做什么限制.</li></ul><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20201202185859.png alt=20201202185859></p><h4 id=jsonp>JSONP</h4><ul><li>JSONP 指的是 JSON with Padding<ul><li>从另一个域请求文件会引起问题,由于跨域政策,从另一个域请求<strong>外部脚本</strong>没有这个问题</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ls
</span></span><span class=line><span class=cl>index.html    server.script
</span></span></code></pre></td></tr></table></div></div><ul><li>index.html</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>使用 script 标签请求 JSON<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>PHP 文件所返回的函数调用处理的是 JSON 数据。<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;demo&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>myFunc</span><span class=p>(</span><span class=nx>myObj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;demo&#34;</span><span class=p>).</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>myObj</span><span class=p>.</span><span class=nx>city</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;server.script&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>server.script</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>myFunc</span><span class=p>({</span> <span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;Bill Gates&#34;</span><span class=p>,</span> <span class=s2>&#34;age&#34;</span><span class=o>:</span><span class=mi>62</span><span class=p>,</span> <span class=s2>&#34;city&#34;</span><span class=o>:</span><span class=s2>&#34;Seattle&#34;</span> <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=jsonp缺陷>JSONP缺陷</h5><ul><li>因为作为一个script标签:<ul><li>一是浏览器只会使用GET方法去请求它</li><li>二是请求它的时候不会携带cookie</li><li>三是能被改造成JSONP形式的api一定是纯粹用来GET数据的.</li></ul></li></ul><p>一是因为JSONP是一种非标准行为，利用了script来做数据的事；
二是它使得别人能直接在他的网页上使用你的数据.</p><h4 id=corscross-origin-resource-sharing>CORS:Cross-Origin Resource Sharing</h4><h5 id=简单请求>简单请求</h5><p>简单的GET和POST。</p><p>当developer.mozilla.org页面请求production.mozilla.org的api.</p><ul><li>浏览器发出请求时，request里会带上Origin头，值为developer.mozilla.org</li><li>当api响应header里带的Access-Control-Allow-Origin字段包含（匹配）了发送请求的页面所在的域名（developer.mozilla.org），浏览器就会认为合法，把数据接着使用。</li><li>否则，浏览器会拦截掉这段数据：没错，响应的数据已经放body里到达了客户端，而<strong>浏览器</strong>会阻止掉，让专栏页面里负责发ajax的那段js代码拿不到响应值。<ul><li>这样的好处很明显：我只需要在服务器端（网关比如nginx这一层）配置好Access-Control-Allow-Origin，从而使后端代码不需要写判断对请求域名进行处理（以前的确写过），就阻止其他人纯前端的手段这些后台数据, 完成了HTTP访问控制。</li></ul></li></ul><h5 id=预检请求>预检请求</h5><p>PUT和DELETE等，或者请求时添加了CORS安全的header之外的header（如自定义的）.</p><p>浏览器主动向目标api发出一个OPTIONS预检请求，这个<strong>请求里</strong>会带<strong>三个</strong>和<strong>跨域相关</strong>的header，其值为预检之后，正式发送api请求时将会使用的</p><ul><li>来源/方法/请求头：<ul><li>Origin</li><li>Access-Control-Request-Method</li><li>Access-Control-Request-Headers
预检请求的响应需要带着与它们对应匹配的header和值，这样浏览器才会去请求跨域api。</li></ul></li></ul><p><a href=https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy>Same-origin policy</a></p><h5 id=带cookie的请求>带cookie的请求</h5><p>要求响应头里Access-Control-Allow-Credentials为true，且Access-Control-Allow-Origin不能是通配符，防止后端犯错。</p><h3 id=点击劫持>点击劫持</h3><p>点击劫持&mdash;clickjacking</p><p>实现原理可以如下：</p><ol><li>假如支付宝有一个页面，页面上的按钮点击是转账1000元给XXX</li><li>我把这个页面作为一个iframe放在a.com的网页上</li><li>我把这个iframe设置为透明，在它的按钮位置下面放置一个可以看见的「下一页」按钮</li><li>你看见我的网页，毫无防备地点击了下一页，实际上点击的位置是转账按钮</li></ol><ul><li>这种「跨域」也有类似CORS的控制方式，即<code>X-Frame-Options</code>响应头。它的值有三种：<ul><li>DENY。表示该页面不允许在 frame 中展示，即便是在相同域名的页面中嵌套也不允许。</li><li>SAMEORIGIN。表示该页面可以在相同域名页面的 frame 中展示。</li><li>ALLOW-FROM uri。表示该页面可以在指定来源（uri）的 frame 中展示。</li></ul></li></ul><p>发现网页在iframe里，且X-Frame-Options响应头的值不符合要求，浏览器不会加载这个iframe。</p><h2 id=附录>附录</h2><p><a href=https://zhuanlan.zhihu.com/p/39466226>为什么给你设置重重障碍？讲一讲Web开发中的跨域</a></p></div></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>zput</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2018-05-24</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/http/>Http</a></div><nav class=post-nav><a class=prev href=/post/_posts/tool/https/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Https = http + ssl</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/_posts/tool/%E8%BF%81%E7%A7%BB%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84/><span class="next-text nav-default">迁移本地环境需要用到的</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:wkzxc@sina.com class="iconfont icon-email" title=email></a>
<a href=https://github.com/zput class="iconfont icon-github" title=github></a>
<a href=http://zput.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=copyright-year>&copy;
2017 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>zput</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=text/javascript>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script></body></html>